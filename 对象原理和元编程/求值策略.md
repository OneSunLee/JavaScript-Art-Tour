## 迷雾清泉·求值策略

---

### 求原始值

JavaScript 通过内置的 `valueOf` 方法来将每一个对象都转换为原始值，如果一个对象自身就是原始值（如数值对象），其 `valueOf` 方法的返回值就是这个对象。如果在一个表达式里面，JavaScript 预期一个对象是原始值，就会悄悄调用这个方法，而不需要我们手动调用。每个对象都拥有 `valueOf` 方法。`Object` 类的原型拥有 `valueOf` 方法，所有对象都继承了它的 `valueOf` 方法，并根据自己的需求定义自己的 `valueOf` 以覆盖原先的。

隐式调用对象的 `valueOf` 方法以求出所需值的过程称为*求值*。只有在表达式需要一个可供计算的数值，而对象类型并不满足要求的情况下，才会自动调用 `valueOf` 方法，否则不会。对于 `Array` 等内置的类，我们可以在必要时重写它们原型上的 `valueOf` 方法。

```javascript
Array.prototype.valueOf = () => 100;
alert([]);      // 这里不需要一个数值，所以没有调用 valueOf 方法
alert([] + 50); // 150
```

不同类型对象的 `valueOf` 方法的默认返回值：

| **类型**   | **返回值**                                   |
| :--------- | :------------------------------------------- |
| `Array`    | 返回数组对象本身。                           |
| `Boolean`  | 布尔值本身。                                 |
| `Date`     | 从 1970 年 1 月 1 日午夜开始到现在的毫秒数。 |
| `Function` | 函数本身。                                   |
| `Number`   | 数值本身。                                   |
| `Object`   | 对象本身（这是默认情况）                     |
| `String`   | 字符串值本身。                               |
| 其它       | Math 和 Error 对象没有 valueOf 方法。        |

假设我们有一个自己的类，需要改变它的实例的默认求值方式，可以定义这个类的专属 `valueOf` 方法，以返回我们需要的值。要注意的一点是，`valueOf` 是不应当有形参的。

```javascript
class Rational {
    constructor(den, num) {
        this.den = den;
        this.num = num;
    }
    valueOf() {
        return [den, num];
    }
};

let r1 = new Rational(10, 20);
alert(r1.valueOf()); // 10,20
alert(r1);           // 10,20
```

重定义 `valueOf` 的一大用处就是使得我们自己的对象可以被处理为原始值并参与计算，使对象在外观上就像普通的值。我们还可以在对对象求值的时候额外执行一些操作。

```javascript
class AnotherNumber {
    constructor(value = 0) {
        this.value = value;
    }
    valueOf() {
        return this.value;
    }
};

let n = new AnotherNumber(100);
alert(n / 20); // 5

class SpecialClass {
    valueOf() {
        alert(`我被求值了！`);
    }
};

let sp = new SpecialClass();
sp.valueOf();    // "我被求值了！"
sp;              // 不需要数值，所以没有调用 valueOf
sp && sp && sp;  // 不需要数值，所以没有调用 valueOf
sp + 1;          // "我被求值了！"
```

